# We're trying to see if Statefullsets can be made to work.
# If we run into problems with multiple shards or zones, we
# may have to switch to the operator managing pods directly.
apiVersion: v1
kind: ConfigMap
metadata:
  name: pg-hba-template
data:
  pg_hba_template.conf: |
    # PostgreSQL Client Authentication Configuration File
    # ===================================================
    #
    # Generated by Multigres - Helping you Scale PostgreSQL
    #
    # This file controls: which hosts are allowed to connect, how clients
    # are authenticated, which PostgreSQL user names they can use, which
    # databases they can access. Records take one of these forms:
    #
    # local      DATABASE  USER  METHOD  [OPTIONS]
    # host       DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
    # hostssl    DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
    # hostnossl  DATABASE  USER  ADDRESS  METHOD  [OPTIONS]

    # TYPE  DATABASE        USER            ADDRESS                 METHOD

    # "local" is for Unix domain socket connections only
    local   all             {{.User}}       trust
    local   all             all             peer

    # Replication connections
    local   replication     all                                     trust
    host    replication     all             0.0.0.0/0               trust
    host    replication     all             ::0/0                   trust

    # IPv4 local connections:
    host    all     all             0.0.0.0/0                       trust
    host    all     all             ::0/0                           trust

    # IPv4 external connections
    host    all     all             0.0.0.0/0                       trust
    host    all     all             ::0/0                           trust

    # IPv6 external connections
    host    all     all             ::0/0                           trust

---
apiVersion: v1
kind: Service
metadata:
  # This name should also have tablegroup, etc.
  # But this will work for now.
  name: multipooler-zone1
spec:
  selector:
    # I don't think these selectors are right either.
    # I think they should have tablegroup, etc.
    # But they'll work for now.
    app: multipooler
    cell: zone1
  ports:
    - port: 16000
      targetPort: 16000
      name: http
    - port: 16100
      targetPort: 16100
      name: grpc
  clusterIP: None # Headless service for StatefulSet
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: multipooler-zone1
  labels:
    app: multipooler
    cell: zone1
spec:
  serviceName: multipooler-zone1
  replicas: 3
  selector:
    matchLabels:
      app: multipooler
      cell: zone1
  template:
    metadata:
      labels:
        app: multipooler
        cell: zone1
    spec:
      initContainers:
        - name: setup-certs
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              cp /certs-secret/ca.crt /certs/ca.crt
              cp /certs-secret/tls.crt /certs/pgbackrest.crt
              cp /certs-secret/tls.key /certs/pgbackrest.key
              chmod 600 /certs/*.key
              chmod 644 /certs/*.crt
          volumeMounts:
            - name: certs-secret
              mountPath: /certs-secret
            - name: certs
              mountPath: /certs
      containers:
        - name: multipooler
          image: docker.io/multigres/multigres:latest
          imagePullPolicy: IfNotPresent
          command: ["/multigres/bin/multipooler"]
          args:
            - --http-port=16000
            - --grpc-port=16100
            - --topo-global-server-addresses=etcd:2379
            - --topo-global-root=/multigres/test/global
            - --cell=zone1
            - --database=postgres
            - --table-group=default
            - --shard=0-inf
            - --service-id=$(POD_INDEX)
            - --pooler-dir=/data
            - --pgctld-addr=localhost:16200
            - --pg-port=5432
            - --connpool-admin-password=postgres
            - --socket-file=/data/pg_sockets/.s.PGSQL.5432
            - --grpc-socket-file=/data/multipooler.sock
            - --service-map=grpc-pooler
            - --pgbackrest-cert-file=/certs/pgbackrest.crt
            - --pgbackrest-key-file=/certs/pgbackrest.key
            - --pgbackrest-ca-file=/certs/ca.crt
            - --pgbackrest-port=8432
            - --pprof-http=true
          ports:
            - containerPort: 16000
              name: http
            - containerPort: 16100
              name: grpc
          livenessProbe:
            httpGet:
              path: /live
              port: 16000
            initialDelaySeconds: 10
            periodSeconds: 10
          volumeMounts:
            # We use the subPathExpr to ensure that each pod
            # gets its own subdirectory.
            - name: host-data
              mountPath: /data
              subPathExpr: $(POD_NAME)
            # certs and backup-data must be common for all pods.
            - name: certs
              mountPath: /certs
            - name: backup-data
              mountPath: /backups
            - name: sampling-config
              mountPath: /etc/otel
              readOnly: true
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_INDEX
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['apps.kubernetes.io/pod-index']
            - name: MT_CELL
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['cell']
            - name: OTEL_SERVICE_NAME
              value: "multipooler"
          envFrom:
            - configMapRef:
                name: otel-config

        - name: pgctld
          image: docker.io/multigres/pgctld-postgres:latest
          imagePullPolicy: IfNotPresent
          command: ["/usr/local/bin/pgctld"]
          args:
            - server
            - --pooler-dir=/data
            - --grpc-port=16200
            - --pg-port=5432
            - --grpc-socket-file=/data/pgctld.sock
            - --pg-hba-template=/etc/pgctld/pg_hba_template.conf
            - --pgbackrest-port=8432
            - --pgbackrest-cert-dir=/certs
            - --pprof-http=true
          ports:
            - containerPort: 16200
              name: pgctldgrpc # This can't be grpc because multipooler has a grpc port.
            - containerPort: 5432
              name: postgres
            - containerPort: 8432
              name: pgbackrest
          volumeMounts:
            - name: host-data
              mountPath: /data
              subPathExpr: $(POD_NAME)
            - name: certs
              mountPath: /certs
            - name: backup-data
              mountPath: /backups
            - name: pg-hba-template
              mountPath: /etc/pgctld
              readOnly: true
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name

      volumes:
        # We have to give different mount points.
        # /data will be mounted using sub path expressions
        # to allow each pod to have its own subdirectory.
        # But backups have to be common for all.
        - name: host-data
          hostPath:
            path: /data
            type: DirectoryOrCreate
        - name: certs-secret
          secret:
            secretName: pgbackrest-tls
        - name: certs
          hostPath:
            path: /data/certs
            type: DirectoryOrCreate
        - name: backup-data
          hostPath:
            path: /data/backups
            type: DirectoryOrCreate
        - name: pg-hba-template
          configMap:
            name: pg-hba-template
        - name: sampling-config
          configMap:
            name: sampling-config
